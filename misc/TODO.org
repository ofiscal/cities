* notes from seminar, 2019 08 16
** draw a benchmark similarly to the city's report
** corrupt governors will suppress the mediax
** TODO before testing the stats, just think about|share them
** can measure complaints of [vote buying] after election
** candidates might use our reports
** control for|stratify by reporters' sense of security
* notes from meeting, 2019 08 14
** regalias
*** oil price fell a lot from 2014 to 2015
But fortunately the regalias data lumps 2013 with 2014,
and 2015 with 2016.
*** the country's revenue split
Is 80% to non-producer munis, and 20% to the few that do produce.
Among those producers it is divided by some complex formula,
taking into account poverty, other things.
** what to use
Obligaciones = money that will be spent. Pagos = money already spent. Obligaciones seems more natural; it includes money that was budgeted this year even if it actually gets spent next year.
** what things are
*** TI.A.1, TI.A.2, TI.B
asignaciones = transferencias
  not including regalias

("Presupuesto Inicial"    , "item init")
  # expectation, proposed by secretary of finance of muni or dept
("Presupuesto Definitivo" , "item def")
  # expectation, approved by city council or state assembly
("Recaudo"                , "item recaudo")
  # what they took in
("Total Ingresos"         , "item total")]
  # ? sould be equal to recaudo
*** spending
These are ordered by time.

("Presupuesto Inicial"    , "item init")
  # proposed by secretary of finance of muni or dept

("Presupuesto Definitivo" , "item def")
  # approved by city council or state assembly

("Compromisos"            , "item comp")
  # the maximum they could use in obligaciones; at end of year, should be equal to obligaciones. this is more disaggregated than the presupuesto.

("Obligaciones"           , "item oblig")
  # both parties promise, neither has delivered yet

("Pagos"                  , "item pagos")
  # what they've actually spent

* TODO send tables to Manuela
** TODO incorporate sort into sum_of_all_but_last_n_rows_in_groups
** TODO use classify_budget_codes.of_interest
to filter rows in the first build stage
** TODO consider the possibility that there are fewer than 5 items
** munis and depts
*** Municipalities
Bogotá
Santa Marta
Filandia
Valle del Guamuez
*** Departamentos
Antioquia
Cesar
Chocó
Arauca
** draw top five categs per muni, and draw the rest together
* TODO draw charts
** compute (muni,series)-specific titles, text, axis names
*** "(upside down ?)Cuanto dinero recibe mi municipio?"
*** "(upside down ?)En que se gasta el dinero mi municipio?"
*** store series-specific titles, text, axis boilerplate
** shrink numbers
*** fewer digits
*** smaller font
** experiment with dimension changes (of whole page)
* TODO fix
** TODO were there not a few negative budget items?
** fix broken OneDrive archive
I added a key, so that OneDrive can't extract and re-archive it,
and now it takes forever to download.
* TODO test
** skipped
*** check the aggregated sums
**** how
For equal values of "muni code" and "agg budget",
  but distinct values of "agg budget =",
  compare peso sums.
**** why
The purpose of aggregation is to sum a.b.c and a.b.d into a.b,
but DNP already provides an a.b value.
Hopefully they are equal.
** unit data tests
*** check other aggregated sums
e.g. T1 = T1.A + T1.B
Good opportunity for property-based testinig.
*** make sure we can ignore VAL
It is the only "codigo budget" that maps to more than one "budget".

If the "subcategory summation" check works,
then ignore these (code, conepto) pairs, because they are redundant.
VAL	INGRESOS TOTALES

Ignore these because they are checks:
VAL	CIFRA CONTROL
VAL	CIFRAS DE CONTROL PARA LOS GASTOS DE FUNCIONAMIENTO
*** "subcategory summation"
Check that, e.g., T1 = T1.A.1 + T1.A.2 + T1.B
** integration data tests
Can check results at
https://terridata.dnp.gov.co/
enter a municipality (department also possible)
and then choose "finanzas publicas".
* PITFALLS interpreting the data
** regalias is not subsampled
So the supposedly subsampled data at or data downstream of
  build/budget_5_deflate_and_regalias.py
will have too many rows in the ingresos data.
This should not matter for drawing charts, though,
as those are always specific to a particular municipality.
** in the raw data
Some series might not be uniformly sampled across time.
* drawing
** TODO get drawStacks() to respect outer subplots
 rework this line:
   fig, (ax) = plt.subplots()
** Emulate the graph on p.2 of the mockup pdf.
*** *???* If boxes are too small to fit a number, aggregate somehow.
*** DONE Stack the boxes, with a line and no space between.
*** legend : draw to the side, not on top of graph
*** Write the total above each stack.
*** Color the boxes per Manuela's specs.
*** DONE Put text indicating the amount on each box.
 "By default, [the x and y arguments to matplotlib.axes.Axes.text() are] in data coordinates."
 https://matplotlib.org/3.1.0/api/_as_gen/matplotlib.axes.Axes.text.html
*** DONE No y-axis. Years on the x-axis.
*** DONE Big space between each column.
*** Change fonts
 refer to fonts/custom-font.py for
**** color: white
**** style: Montserrat black & Montserrat light
 source code: https://github.com/JulietaUla/Montserrat
 main page: https://fonts.google.com/specimen/Montserrat
*** Include text from an accompanying .txt file.
** TODO build a pdf
*** TODO use matplotlib
*** DONE reportlab is too complex and unfree
 pip3 install reportlab
**** DONE ReportLab
 https://www.reportlab.com/documentation/
**** custom fonts in reportlab
 https://www.reportlab.com/documentation/faq/#2.6.2
*** DONE pyfpdf appears to badly support Python 3
 pip install --upgrade pip # afte running this, did not have pip3
 seems to be working: "python3 -m pip install fpdf"
 recommended was      "python  -m pip install fpdf"
** wish: that I could set font only once, affecting all types of text
* gotchas
** the boolean value of np.nan is True
** underscores in filenames seem to confuse Matplotlib's font_manager
https://github.com/matplotlib/matplotlib/issues/14536
** local modules must begin with a capital letter to be imported in Jupyter
Keeping all code in a top-level folder that starts with a capital letter solves this problem. Subfolders and files suffer no naming restriction.
** every code folder needs a __init__.py file
as of some recent version of Python
** change every background color: methods that didn't work
*** plt.rcParams['axes.facecolor] = 'b'
Changes the legend background, nothing else
*** ax.set_facecolor('b')
no discernible effect
*** ax.patch.set_facecolor('b')
no discernible effect
*** fig.add_subplot(2, 1, 1, facecolor = "red")
causes the second figure not to be drawn,
no other discernible effect
**** code example
   fig = Figure()

   ax = fig.add_subplot(2, 1, 1, facecolor = "red")
   drawText( ax, lines )
*** pdf.savefig() overrides background color in figures
https://stackoverflow.com/questions/56606122/matplotlib-use-the-same-custom-font-in-every-kind-of-text-axes-title-text
* internalized or stale
** how the raw data is organized
*** isomorphisms relate some columns
Determined via Code/bijectivity_test.py.
For one-to-many mappings, see output/non_bijective/*.csv
**** Codigo Concepto => Concepto, roughly
Some codes map to more than one concepto (budget item) name.
However, those are highly disaggregated.
Codes for the big categories all map to a single concepto name,
with the exception of "VAL", which is *so* broad that it's not useful.
**** simple isomorphic pairs
Código FUT, Nombre Entidad
  I suspect this is isomorphic to muni code
Cód. DANE Departamento, Nombre DANE Departamento
**** Cód. DANE Municipio <=> (Nombre DANE Municipio, Nombre DANE Departamento)
Problem: Cód. DANE Municipio <=/=> Nombre DANE Municipio
  No codigo maps to multiple nombres,
  but some "Nombre DANE Municipio"s map to multiple codigos,
Solution: The ambiguity disappears once we include department.
  The problem was simply that some cities in different departments share a name.
**** not isomorphic, but don't care (yet, at least)
Código Fuente Financiación, Fuente Financiación
Código Fuentes De Financiación, Fuentes de Financiación
*** regions
**** are almost uniquely identified by 8|9 digit codes
Some valid 8-digit codes are subsets of valid 9-digit ones.
Will therefore need to find the best regex match to the name.
**** a nearly-comprehensive list of them
comes from Directorio_CHIP_Mesa_de_Ayuda_Contraloria_2009.xls
  (which Juan found)
A subset of it became data/regions/*.csv
Municipalities are those in which the first column is 21.
  That rule collects 9 false positives,
  all of which match one of these two regular expressions:
    ^DEFENSA CIVIL COLOMBIANA$
    ^CORPORACION.*
  They have been deleted.
Departments are those in which the first column is 11.

* DONE
** build data
*** write code (string) interpretation functions
**** codes to aggregate
***** Ingresos
TI.A.1
TI.A.2
TI.B
***** For all other series, just use the first two coordinates.
Note that the a subcode sometimes has 1 character, sometimes 2.
*** apply code interpretation functions to data
**** keep data separate by originating dataset
i.e. funcionamiento, inversion, ingreso
Pool for the creation of keys, but not for aggregating numbers.
**** create aggregated-code columns
Key on the "codigo budget" column.
Use first_n_subcodes() to generate 2 columns:
  "agg budget  " : string = the first 2 subcodes
  "agg budget =" : bool, indicates whether a code
                     is equal to its first two subcodes
For ingreso data, use ingreso_subcodes() to generate 2 columns:
  "agg budget"   : string = the subcode prefix of interest
  "agg budget =" : bool, indicates whether a code
                     is equal to its agg subcodes
**** aggregate rows
Group by "year", "muni code", "agg budget" and "agg budget =".
Sum the peso-valued columns.
**** reconstitute budget column, using keys in output/keys
** sum only first-generation descendents of aggregate budgets
*** replace `regex_for_at_least_n_codes` with
something of type :: int -> (Patthern,Pattern,Pattern)
where the first is the category,
the second matches only the top of the category,
and the third matches immediate children (not grandchildren, etc.) of the category.
These will be called budget-code, budgetp-code-top, and budget-code-child.
*** Replace `ingreso_regex` with similar
*** in the last part of budgets_1.py
Build those three columns.
Delete rows for which neither "top" nor "child" are true.
*** in budgets_2_agg.py
Aggregate on year, muni, dept, budget-code and budget-code-top.
*** Verify that top + child = 1 (after deleting rows).
*** delete "codigo-child"
It should be redundant to "top",
  and putting it through .agg(sum) downstream is confusing.
** compare order of magnitude of figures across years
*** problem: Figures, at least for ingresos, are 1e3 times bigger after 2016
*** method
 Within each municipality-item "mi" indexed by year "y",
 compute the ratio of mi[y] / mi[y+1], for y in [2012 .. 2017].
 (Use the "pct_change" function from pandas for this.)
 Put each in a separate column.
 Across municipality-items, find the min, max of each column.
*** TODO use assertions
 After correcting the data (multiplying peso values pre-2017 by 1000),
 it should be that,
 for each of the 3 kinds of file and each year after the first (2012),
 the median change is less than, say, 0.1.
